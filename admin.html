<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AscendX Admin</title>

<style>
body{
  font-family:Inter, sans-serif;
  background:#f4f7fb;
  margin:0;
  padding:20px;
}

h1{margin-bottom:20px}

.card{
  background:white;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

input, select, textarea{
  padding:8px;
  border-radius:8px;
  border:1px solid #ddd;
  margin-bottom:8px;
  width:100%;
}

button{
  padding:6px 10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-left:4px;
  background:#0b2340;
  color:white;
}

button.secondary{
  background:#eee;
  color:#333;
}

.module, .lesson{
  background:#f9fbff;
  padding:10px;
  border-radius:8px;
  margin-top:10px;
}

.lesson{
  background:#eef3ff;
}

.draggable{
  cursor:move;
}

.toolbar button{
  background:#eee;
  color:#333;
}
</style>
</head>
<body>

<h1>AscendX Admin Panel</h1>

<div class="card">
  <h3>Select Course</h3>
  <select id="courseSelect"></select>
  <button onclick="deleteCourse()">Delete Course</button>
</div>

<div class="card">
  <h3>Add New Course</h3>
  <input id="newCourseTitle" placeholder="Course Title">
  <button onclick="addCourse()">Add Course</button>
</div>

<div class="card">
  <h3>Add Module</h3>
  <input id="moduleTitle" placeholder="Module Title">
  <input id="moduleDesc" placeholder="Module Description">
  <button onclick="addModule()">Add Module</button>
</div>

<div class="card">
  <h3>Add Lesson (to selected module)</h3>
  <select id="moduleSelect"></select>
  <input id="lessonTitle" placeholder="Lesson Title">
  
  <div class="toolbar">
    <button onclick="format('bold')">Bold</button>
    <button onclick="format('italic')">Italic</button>
    <button onclick="format('insertUnorderedList')">Bullet</button>
  </div>
  
  <div id="lessonContent" contenteditable="true" style="border:1px solid #ddd; padding:10px; border-radius:8px; min-height:120px;"></div>
  
  <button onclick="addLesson()">Add Lesson</button>
</div>

<div class="card">
  <h3>Structure</h3>
  <div id="preview"></div>
</div>

<div class="card">
  <button onclick="saveToGitHub()">Save to GitHub</button>
</div>

<script>
const USERNAME='Ray-Sage';
const REPO='AscendX';
const FILE_PATH='courses.json';
const TOKEN='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';

let COURSES=[];
let currentCourse=0;

/* INIT */
window.onload=async()=>{
  await loadCourses();
};

/* LOAD */
async function loadCourses(){
  try{
    const r=await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${FILE_PATH}`);
    COURSES=await r.json();
  }catch{
    COURSES=[];
  }
  render();
}

/* RENDER */
function render(){
  renderCourseSelect();
  renderModuleSelect();
  renderPreview();
}

function renderCourseSelect(){
  const sel=document.getElementById('courseSelect');
  sel.innerHTML='';
  COURSES.forEach((c,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=c.title;
    sel.appendChild(o);
  });
  sel.value=currentCourse;
  sel.onchange=e=>{
    currentCourse=+e.target.value;
    render();
  }
}

function renderModuleSelect(){
  const sel=document.getElementById('moduleSelect');
  sel.innerHTML='';
  const mods=COURSES[currentCourse]?.modules||[];
  mods.forEach((m,i)=>{
    const o=document.createElement('option');
    o.value=i;
    o.textContent=m.title;
    sel.appendChild(o);
  });
}

function renderPreview(){
  const div=document.getElementById('preview');
  div.innerHTML='';
  const course=COURSES[currentCourse];
  if(!course) return;

  course.modules?.forEach((m,mi)=>{
    const mod=document.createElement('div');
    mod.className='module draggable';
    mod.draggable=true;
    mod.ondragstart=e=>dragStart(e,mi,'module');
    mod.innerHTML=`
      <strong>${m.title}</strong>
      <button onclick="moveModule(${mi},-1)">↑</button>
      <button onclick="moveModule(${mi},1)">↓</button>
      <button onclick="editModule(${mi})">Edit</button>
      <button onclick="deleteModule(${mi})">Delete</button>
    `;
    m.lessons?.forEach((l,li)=>{
      const les=document.createElement('div');
      les.className='lesson draggable';
      les.draggable=true;
      les.ondragstart=e=>dragStart(e,li,'lesson',mi);
      les.innerHTML=`
        ${l.title}
        <button onclick="moveLesson(${mi},${li},-1)">↑</button>
        <button onclick="moveLesson(${mi},${li},1)">↓</button>
        <button onclick="editLesson(${mi},${li})">Edit</button>
        <button onclick="deleteLesson(${mi},${li})">Delete</button>
      `;
      mod.appendChild(les);
    });
    div.appendChild(mod);
  });
}

/* COURSE */
function addCourse(){
  const title=document.getElementById('newCourseTitle').value;
  if(!title) return;
  COURSES.push({title,modules:[]});
  currentCourse=COURSES.length-1;
  render();
}

function deleteCourse(){
  if(!confirm('Delete course?')) return;
  COURSES.splice(currentCourse,1);
  currentCourse=0;
  render();
}

/* MODULE */
function addModule(){
  const t=document.getElementById('moduleTitle').value;
  const d=document.getElementById('moduleDesc').value;
  if(!t) return;
  COURSES[currentCourse].modules.push({title:t,desc:d,lessons:[]});
  render();
}

function deleteModule(i){
  COURSES[currentCourse].modules.splice(i,1);
  render();
}

function editModule(i){
  const n=prompt('New module title');
  if(n) COURSES[currentCourse].modules[i].title=n;
  render();
}

function moveModule(i,d){
  const mods=COURSES[currentCourse].modules;
  if(i+d<0||i+d>=mods.length) return;
  [mods[i],mods[i+d]]=[mods[i+d],mods[i]];
  render();
}

/* LESSON */
function addLesson(){
  const mi=document.getElementById('moduleSelect').value;
  const title=document.getElementById('lessonTitle').value;
  const content=document.getElementById('lessonContent').innerHTML;
  if(!title) return;
  COURSES[currentCourse].modules[mi].lessons.push({title,content});
  render();
}

function deleteLesson(mi,li){
  COURSES[currentCourse].modules[mi].lessons.splice(li,1);
  render();
}

function editLesson(mi,li){
  const n=prompt('New lesson title');
  if(n) COURSES[currentCourse].modules[mi].lessons[li].title=n;
  render();
}

function moveLesson(mi,li,d){
  const les=COURSES[currentCourse].modules[mi].lessons;
  if(li+d<0||li+d>=les.length) return;
  [les[li],les[li+d]]=[les[li+d],les[li]];
  render();
}

/* DRAG */
function dragStart(e,index,type,mi){
  e.dataTransfer.setData('index',index);
  e.dataTransfer.setData('type',type);
  if(mi!==undefined) e.dataTransfer.setData('moduleIndex',mi);
}

/* RICH TEXT */
function format(cmd){
  document.execCommand(cmd,false,null);
}

/* SAVE */
async function saveToGitHub(){
  const res=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`,{
    headers:{Authorization:`token ${TOKEN}`}
  });
  const data=await res.json();
  const sha=data.sha;

  await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`,{
    method:'PUT',
    headers:{
      Authorization:`token ${TOKEN}`,
      'Content-Type':'application/json'
    },
    body:JSON.stringify({
      message:'Update courses',
      content:btoa(unescape(encodeURIComponent(JSON.stringify(COURSES,null,2)))),
      sha
    })
  });

  alert('Saved to GitHub!');
}
</script>

</body>
</html>
